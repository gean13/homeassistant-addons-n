version: 2.1
executors:
  arm-executor:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
orbs:
  docker: circleci/docker@2.1.3
  yq: nikkei/rnikkei-yq@0.0.3
jobs:
  install-yq:
    executor: arm-executor
    steps:
     - yq/install 
workflows:
  build-and-publish-addons-images:
    jobs:
      - install-yq
      - docker/publish:
          matrix:
            parameters:
              path: [rtl4332mqtt-interlogix-autodiscovery,tshark,oauth2-proxy,dropbox-autodelete,nginx_proxy]
              context: [build-architecture, build-aarch64]
          pre-steps:
            - checkout
            #- run:
            #    command: echo 'export ARCH=armv7' >> "$BASH_ENV"
            - run:
                command: echo 'export PLATFORM=$(cat ./<< matrix.path >>/build.yml | yq '"'"'.platform.[env(ARCH)]'"'"')' >> "$BASH_ENV"
            - checkout
            - run:
                command: echo 'export TAG=$(cat ./<< matrix.path >>/config.yml | yq '"'"'.version'"'"')' >> "$BASH_ENV"
            - run:
                command: echo $ARCH && echo $PLATFORM && echo $TAG
          name: Publish $ARCH-<< matrix.path >> addon
          image: $DOCKER_LOGIN/$ARCH-<< matrix.path >>
          extra_build_args: --build-arg BUILD_FROM=ghcr.io/home-assistant/$ARCH-base:latest --platform $PLATFORM
          executor: arm-executor
          docker-context: << matrix.path >>
          tag: $TAG